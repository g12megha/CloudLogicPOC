'use strict';

var tough = require('tough-cookie');
var sessionExt = require('../utils/session-ext');

/**
 * Stores the session cookies of a response into the serverside session of the client.
 * All non session cookies are delivered to the client.
 *
 * @param {String} url  The request url
 * @param {Object} responseHeaders All headers of the response
 * @param {Object} req The request object
 */
exports.storeSessionCookies =
function (url, responseHeaders, req) {
  var cookieHeader = responseHeaders['set-cookie'];
  var sessionCookies = [];
  var nonSessionCookies = [];

  if (cookieHeader) {
    for (var i = 0; i < cookieHeader.length; i++) {
      var oCookie = tough.Cookie.parse(cookieHeader[i]);
      if (isSessionCookie(oCookie)) {
        sessionCookies.push(oCookie);
      } else {
        nonSessionCookies.push(cookieHeader[i]);
      }
    }
    if (sessionCookies.length > 0) {
      sessionExt.update(req.session, function(session) {
        var cookieJar = session._cookieJar ?
          tough.CookieJar.deserializeSync(session._cookieJar) : new tough.CookieJar();
        sessionCookies.forEach(function(oCookie) {
          cookieJar.setCookieSync(oCookie, url);
        });
        session._cookieJar = cookieJar.serializeSync();
      });
    }
    delete responseHeaders['set-cookie'];
    if (nonSessionCookies.length > 0) {
      responseHeaders['set-cookie'] = nonSessionCookies;
    }
  }
};

function isSessionCookie(oCookie) {
  return (!oCookie.expires || oCookie.expires === 'Infinity') && (!oCookie.maxAge || oCookie.maxAge === 'Infinity');
}
