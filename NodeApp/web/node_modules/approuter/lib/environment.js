'use strict';

var path = require('path');
var logger = require('./utils/logger').getLogger('/Configuration');
var tracer = require('./utils/logger').getTracer();
var fsUtils = require('./utils/fs-utils');
var vcapUtils = require('./utils/vcap-utils');
var localConfig = require('./configuration/local-config');

module.exports = {
  getPort: function(port) {
    var usedPort;
    if (process.env.VCAP_APP_PORT) {
      usedPort = process.env.VCAP_APP_PORT;
    } else if (port) {
      usedPort = port;
    } else {
      usedPort = '5000';
    }

    logger.info('Using port: ' + usedPort);

    return usedPort;
  },

  getWorkingDirectory: function() {
    for (var i = 0; i < arguments.length; i++) {
      tracer.info('Checking file existence: ' + arguments[i] + path.sep + 'xs-app.json');
      if (arguments[i] && fsUtils.isFile(arguments[i] + path.sep + 'xs-app.json')) {
        tracer.info('Using working directory: ' + arguments[i]);
        return arguments[i];
      }
    }
    throw new Error('Cannot find a working directory containing the xs-app.json file.');
  },

  getLocalServiceConfigPath: function(workingDirectory) {
    if (!vcapUtils.isLocal()) {
      return;
    }

    var serviceConfig = workingDirectory + path.sep + 'default-services.json';
    return localConfig.findLocalConfigFile(serviceConfig, 'services');
  }
};
