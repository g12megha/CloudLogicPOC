'use strict';

var OVERWRITE_HEADER_NAMES = {
  'x-frame-options': true
};

module.exports = function additionalHeaders(req, res, next) {
  var routerConfig = req.app.get('routerConfig');
  setDefaultResponseHeaders(routerConfig, res);

  var additionalHeaders = routerConfig.additionalHeaders;
  additionalHeaders.forEach(function (header) {
    for (var name in header) {
      if (name) {
        var normalizedName = name.toLowerCase();

        // http://tools.ietf.org/html/rfc7230#section-3.2.2
        // Express's Response.append method is adding values as comma separated list
        if (normalizedName in OVERWRITE_HEADER_NAMES) {
          res.setHeader(normalizedName, header[name]);
        } else {
          var h = res.getHeader(normalizedName);
          if (h === undefined) {
            res.setHeader(normalizedName, header[name]);
          } else if (Array.isArray(h)) {
            h.push(header[name]);
          } else { // string
            res.setHeader(normalizedName, [h, header[name]]);
          }
        }
      }
    }
  });

  next();
};

function setDefaultResponseHeaders(routerConfig, res) {
  if (routerConfig.sendXFrameOptions) {
    res.setHeader('x-frame-options', 'SAMEORIGIN');
  }
}
