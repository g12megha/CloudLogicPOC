'use strict';

var loggingUtils = require('../utils/logger');
var logger = loggingUtils.getLogger('/Middleware');

module.exports = function isAuthorized(req) {
  if (!req.internalUrl) {
    return true;
  }

  var routeScopes = req.internalUrl.route.scope;
  if (!routeScopes) {
    return true;
  }
  if (!Array.isArray(routeScopes)) {
    routeScopes = routeScopes[req.method] || routeScopes.default || [];
  }
  var oauthScopes = req.session && req.session.oauthScopes;
  if (routeScopes && !oauthScopes) {
    return false;
  }

  var isAuthorized = routeScopes.some(function(element) {
    return oauthScopes.indexOf(element) > -1;
  });
  if (!isAuthorized) {
    logger.info("User not authorized for route with source '%s'. One of following scopes is required: %j. User has the following scopes: %j",
      req.internalUrl.route.source, routeScopes, oauthScopes);
  }

  return isAuthorized;
};
