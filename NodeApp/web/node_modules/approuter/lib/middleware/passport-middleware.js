'use strict';
var passport = require('passport');
var xhr = require('../xhr-login/xhr');
var sessionExt = require('../utils/session-ext');

module.exports = function passportLogin(req, res, next) {
  if (req.method !== 'GET') {
    return next();
  }
  passport.authenticate('oauth2', function (err, user) {
    if (err) {
      return next(err);
    }
    if (!user) {
      res.writeHead(302, { location: '/' });
      res.end();
      return;
    }
    req.logIn(user, function (err) {
      if (err) {
        return next(err);
      }
      if (xhr.isXhrLogin(req)) {
        return xhr.sendLoginSuccessHtml(res);
      }
      res.writeHead(302, { location: req.session.locationAfterLogin });
      sessionExt.update(req.session, function (session) {
        session.locationAfterLogin = undefined;
      });
      res.end();
    });
  })(req, res, next);
};
