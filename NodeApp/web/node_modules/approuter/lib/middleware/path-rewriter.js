'use strict';

var _ = require('lodash');
var urlUtils = require('../utils/url-utils');

module.exports = function (req, routerConfig) {
  var routes = routerConfig.appConfig.routes;
  if (!routes) {
    return;
  }

  for (var i = 0; i < routes.length; i++) {
    var route = routes[i];
    if (route.source.test(req.url)) {
      var rewrittenUrl = applyRewriteRule(req, route, routerConfig);
      return rewrittenUrl;
    }
  }
};

function applyRewriteRule(req, route, routerConfig) {
  var destination = route.destination;
  var path;

  if (route.target) {
    path = req.url.replace(route.source, route.target);
  } else {
    path = req.url;
  }
  var rewrittenUrl = null;
  if (destination) {
    var oDestination = routerConfig.destinations[destination];
    rewrittenUrl = urlUtils.parse(_.trimRight(oDestination.url, '/') + '/' + _.trimLeft(path, '/'));
    rewrittenUrl.destination = oDestination;
  } else {
    rewrittenUrl = urlUtils.parse(path);
  }
  rewrittenUrl.route = route;
  return rewrittenUrl;
}
