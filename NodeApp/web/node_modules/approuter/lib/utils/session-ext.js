'use strict';

exports.update = update;

/**
 * Applies atomic session changes
 *
 * Both reads updates from parallel requests and saves the changes so
 * they are visible by parallel requests.
 *
 * Note that this function replaces the session object.
 *
 * DO NOT perform async operations in change function as this may allow
 * parallel requests to change the session
 *
 * @param {object} session The session object
 * @param {function} change A function that changes the session - function change(session)
 */
function update(session, change) {
  var req = session.req;

  // reload creates new session object
  req.session.reload(function () {
    change(req.session);
    req.session.save();
  });
}
