'use strict';

var ws = require('ws');
var ConnectionHandler = require('./ConnectionHandler');
var loggerUtil = require('../utils/logger');

module.exports = WsProxy;

function WsProxy(approuter) {
  this._approuter = approuter;
  this._server = null;
}

WsProxy.prototype.listen = function (httpServer) {
  var self = this;
  if (this._server) {
    throw new Error('Web socket server already running!');
  }
  this._server = new ws.Server({ server: httpServer });
  this._server.on('connection', function serverConnection(incoming) {
    var httpReq = incoming.upgradeReq;
    var loggingContext = loggerUtil.createRequestContext(httpReq);
    httpReq.loggingContext = loggingContext;

    var handler = new ConnectionHandler(loggingContext);
    handler.createConnection(incoming, self._approuter);
  });
};
